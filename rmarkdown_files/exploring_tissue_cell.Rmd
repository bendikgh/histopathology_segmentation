---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.15.2
  kernelspec:
    display_name: master_project
    language: python
    name: python3
---

```{python}
# Fixing automatic autoreload
# %load_ext autoreload
# %autoreload 2
```

```{python}
import os 

import os 

# Making sure we are running the code from the root directory
current_directory = os.getcwd()
if current_directory.endswith("notebooks"):
    os.chdir("..")
    print("Changed directory to:", os.getcwd())
else:
    print("Directory was already correct, so did not change.")

import torch
import matplotlib.pyplot as plt 
import seaborn as sns

from glob import glob
from torch.utils.data import DataLoader
from torch.nn.functional import softmax
from torchvision.transforms import ToTensor

from PIL import Image

import numpy as np
```

```{python}
from src.utils import (
    read_data
)

from src.dataset import TissueLeakingDataset
```

```{python}
on_idun = True
if on_idun:
  data_path = "/cluster/projects/vc/data/mic/open/OCELOT/ocelot_data"
else: 
  data_path = "ocelot_data/"

train_data, val_data, test_data = read_data(data_path, fetch_images=False)

total_data = {}
total_data.update(train_data)
total_data.update(val_data)
total_data.update(test_data)

annotation_path = os.path.join(data_path, "annotations")
```

```{python}
print(total_data["001"]["cell_annotated"])
print(total_data["001"]["tissue_image"])
```

```{python}
# 204 looks good. The tissue is cropped correct and the cancer cells is within the cancer tissue area

sample_nr = "218"

train_input_img = [train_data[sample_nr]["cell_image"]]
train_cell_seg = [train_data[sample_nr]["segmented_cell"]]
train_tissue_seg = [train_data[sample_nr]["tissue_cropped_annotated"]]
```

```{python}
print(train_input_img)
print(train_cell_seg)
print(train_tissue_seg)
```

```{python}
train_dataset = TissueLeakingDataset(input_files=train_input_img, cell_seg_files=train_cell_seg, tissue_seg_files=train_tissue_seg)
train_dataloader = DataLoader(dataset=train_dataset, batch_size=1)
```

```{python}
it = iter(train_dataloader)
image, seg = next(it)
```

```{python}
image.size()
```

```{python}
train_tissue_image = train_data[sample_nr]["tissue_image"]
train_tissue_tensor = ToTensor()(Image.open(train_tissue_image).convert("RGB"))
```

```{python}
input_image = image[0, :3].cpu()
tissue_croped_image = image[0, 3].cpu().unsqueeze(0)

plt.figure(figsize=(12, 4))

plt.subplot(1, 4, 1)
plt.xlim(0, 1024)
plt.ylim(0, 1024)
plt.gca().invert_yaxis()
plt.imshow(seg.squeeze().permute(1, 2, 0))
plt.title("Segmentation cell")
plt.axis("off")

plt.subplot(1, 4, 2)
plt.imshow(train_tissue_tensor.permute(1, 2, 0))
plt.title("Tissue")
plt.axis("off")
plt.tight_layout()

plt.subplot(1, 4, 3)
plt.imshow(tissue_croped_image.permute(1, 2, 0))
plt.title("Tissue cropped")
plt.axis("off")
plt.tight_layout()


plt.subplot(1, 4, 4)
plt.imshow(input_image.permute(1, 2, 0))
plt.title("Input image")
plt.axis("off")
plt.tight_layout()
plt.show()
```
