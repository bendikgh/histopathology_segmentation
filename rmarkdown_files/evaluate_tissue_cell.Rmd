---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.15.2
  kernelspec:
    display_name: specialization_project
    language: python
    name: python3
---

```{python}
# Fixing automatic autoreload
# %load_ext autoreload
# %autoreload 2
```

```{python}
import os 

# Making sure we are running the code from the root directory
current_directory = os.getcwd()
if current_directory.endswith("notebooks"):
    os.chdir("..")
    print("Changed directory to:", os.getcwd())
else:
    print("Directory was already correct, so did not change.")
```

```{python}
import torch
import albumentations as A
import matplotlib.pyplot as plt

from glob import glob
from monai.data import DataLoader

from src.deeplabv3.network.modeling import _segm_resnet
from src.dataset import CellTissueDataset
from src.utils.metrics import calculate_f1_score

device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
print(f"device: {device}")
```

```{python}
data_path = "/cluster/projects/vc/data/mic/open/OCELOT/ocelot_data"

train_seg_files = glob(os.path.join(data_path, "annotations/train/segmented_cell/*"))
train_image_numbers = [
    file_name.split("/")[-1].split(".")[0] for file_name in train_seg_files
]
train_image_files = [
    os.path.join(data_path, "images/train/cell", image_number + ".jpg")
    for image_number in train_image_numbers
]

val_seg_files = glob(os.path.join(data_path, "annotations/val/segmented_cell/*"))
val_image_numbers = [
    file_name.split("/")[-1].split(".")[0] for file_name in val_seg_files
]
val_image_files = [
    os.path.join(data_path, "images/val/cell", image_number + ".jpg")
    for image_number in val_image_numbers
]

test_seg_files = glob(os.path.join(data_path, "annotations/test/segmented_cell/*"))
test_image_numbers = [
    file_name.split("/")[-1].split(".")[0] for file_name in test_seg_files
]
test_image_files = [
    os.path.join(data_path, "images/test/cell", image_number + ".jpg")
    for image_number in test_image_numbers
]
```

```{python}
train_tissue_predicted = glob(os.path.join(data_path, "annotations/train/pred_tissue/*"))
val_tissue_predicted = glob(os.path.join(data_path, "annotations/val/pred_tissue/*"))
test_tissue_predicted = glob(os.path.join(data_path, "annotations/test/pred_tissue/*"))
```

```{python}
transforms = A.Compose(
    [
        A.GaussianBlur(blur_limit=(3, 7), p=0.5),
        A.GaussNoise(var_limit=(0.1, 0.3), p=0.5),
        A.ColorJitter(brightness=0.2, contrast=0.3, saturation=0.2, hue=0.1, p=1),
        A.HorizontalFlip(p=0.5),
        A.RandomRotate90(p=0.5),
    ],
    additional_targets={"mask1": "mask", "mask2": "mask"},
)
```

```{python}
batch_size = 2

train_cell_tissue_dataset = CellTissueDataset(
    image_files=train_image_files,
    seg_files=train_seg_files,
    image_tissue_files=train_tissue_predicted,
    transform=transforms,
)
val_cell_tissue_dataset = CellTissueDataset(
    image_files=val_image_files,
    seg_files=val_seg_files,
    image_tissue_files=val_tissue_predicted,
)
test_cell_tissue_dataset = CellTissueDataset(
    image_files=test_image_files,
    seg_files=test_seg_files,
    image_tissue_files=test_tissue_predicted,
)

train_cell_tissue_dataloader = DataLoader(
    dataset=train_cell_tissue_dataset, batch_size=batch_size, drop_last=True
)
val_cell_tissue_dataloader = DataLoader(
    dataset=val_cell_tissue_dataset, batch_size=batch_size
)
test_cell_tissue_dataloader = DataLoader(
    dataset=test_cell_tissue_dataset, batch_size=batch_size
)
```

```{python}
backbone = "resnet50"
dropout_rate = 0.3
tissue_cell_model = _segm_resnet(
    name="deeplabv3plus",
    backbone_name=backbone,
    num_classes=3,
    output_stride=8,
    pretrained_backbone=True,
    dropout_rate=dropout_rate,
    num_channels=6,
)
tissue_cell_model.to(device)
# tissue_cell_model.load_state_dict(
#     torch.load(
#         "outputs/models/20240212_110625_deeplabv3plus_cell_branch_lr-0.0001_dropout-0.3_backbone-resnet50_epochs-5.pth"
#     )
# )
tissue_cell_model.eval()
print()
```

```{python}
val_score = calculate_f1_score(model=tissue_cell_model, dataloader=val_cell_tissue_dataloader, device=device)
print(f"Validation score: {val_score}")
test_score = calculate_f1_score(model=tissue_cell_model, dataloader=test_cell_tissue_dataloader, device=device)
print(f"Test score: {test_score}")
```

```{python}
it = iter(val_cell_tissue_dataloader)
images, labels = next(it)

image = images[0]
label = labels[0]

cell_image = image[:3]
tissue_image = image[3:]

print(cell_image.shape)
print(tissue_image.shape)
print(label.shape)
```

```{python}
outputs = tissue_cell_model(images.to(device))
output = outputs[0]
print(output.shape)
```

```{python}
argmaxed = output.argmax(0)
print(argmaxed.shape)
```

```{python}
plt.figure(figsize=(20, 6))
plt.title("Model outputs (Tissue-Cell)")
plt.axis("off")

plt.subplot(1, 4, 1)
plt.imshow(cell_image.permute(1, 2, 0))
plt.title("Cell image")
plt.axis("off")

plt.subplot(1, 4, 2)
plt.imshow(tissue_image.permute(1, 2, 0))
plt.title("Tissue image")
plt.axis("off")

plt.subplot(1, 4, 3)
plt.imshow(label.permute(1, 2, 0))
plt.title("Label")
plt.axis("off")

plt.subplot(1, 4, 4)
plt.imshow(argmaxed.detach().cpu())
plt.title("Argmaxed Model Predictions")
plt.axis("off")

plt.tight_layout()
plt.show()
```
