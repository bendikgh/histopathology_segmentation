---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.15.2
  kernelspec:
    display_name: specialization_project
    language: python
    name: python3
---

```{python}
# Fixing automatic autoreload
# %load_ext autoreload
# %autoreload 2


# Making sure we are running the code from the root directory
import os 
current_directory = os.getcwd()
if current_directory.endswith("notebooks"):
    os.chdir("..")
    print("Changed directory to:", os.getcwd())
else:
    print("Directory was already correct, so did not change.")
```

```{python}
import cv2
import torch
import numpy as np
import matplotlib.pyplot as plt

from src.utils.utils import get_ocelot_files
from src.utils.constants import IDUN_OCELOT_DATA_PATH
```

```{python}
train_cell_image_files, train_cell_target_files = get_ocelot_files(
    data_dir=IDUN_OCELOT_DATA_PATH,
    partition="train",
    zoom="cell"
)
train_tissue_image_files, train_tissue_target_files = get_ocelot_files(
    data_dir=IDUN_OCELOT_DATA_PATH,
    partition="train",
    zoom="tissue"
)
```

```{python}
print(train_cell_image_files)
print(len(train_cell_image_files)) # This is 395

cell_images = np.zeros((len(train_cell_image_files), 1024, 1024, 3), dtype=np.double)

for idx, path in enumerate(train_cell_image_files):  
  image = cv2.imread(path)
  image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
  image = image.astype(np.double) / 255.0
  cell_images[idx, ...] = image[:]

# NOTE: axis=(0, 1, 2) only works with double precision
print(cell_images.mean(axis=(0, 1, 2))) 
print(cell_images.std(axis=(0, 1, 2)))
```

```{python}
print(train_tissue_image_files)
print(len(train_tissue_image_files)) # This is 395

tissue_images = np.zeros((len(train_tissue_image_files), 1024, 1024, 3), dtype=np.double)

for idx, path in enumerate(train_tissue_image_files):  
  image = cv2.imread(path)
  image = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)
  image = image.astype(np.double) / 255.0
  tissue_images[idx, ...] = image[:]

# NOTE: axis=(0, 1, 2) only works with double precision
print(tissue_images.mean(axis=(0, 1, 2))) 
print(tissue_images.std(axis=(0, 1, 2)))
```

```{python}
from glob import glob
# Checking the written images 

train_tissue_predicted = glob(
    os.path.join(IDUN_OCELOT_DATA_PATH, "annotations/train/pred_tissue/*")
)
train_tissue_predicted.sort(key = lambda x: int(x.split("/")[-1].split(".")[0]))
print(train_tissue_predicted[-10:])
print(train_cell_image_files[-10:])


for i in range(360, len(train_tissue_predicted)): 
  cell_path = train_cell_image_files[i]
  pred_path = train_tissue_predicted[i]

  cell_img = cv2.imread(cell_path)
  cell_img = cv2.cvtColor(cell_img, cv2.COLOR_BGR2RGB)

  pred_img = cv2.imread(pred_path)
  pred_img = cv2.cvtColor(pred_img, cv2.COLOR_BGR2RGB)

  fig, ax = plt.subplots(1, 2, figsize=(10, 5))
  ax[0].imshow(cell_img)
  ax[0].set_title("Cell Image")

  ax[1].imshow(pred_img*255)
  ax[1].set_title("Prediction")
  plt.show()


```
