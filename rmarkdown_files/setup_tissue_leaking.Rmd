---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.15.2
  kernelspec:
    display_name: specialization_project
    language: python
    name: python3
---

```{python}
# Fixing automatic autoreload
# %load_ext autoreload
# %autoreload 2

import os 

# Making sure we are running the code from the root directory
current_directory = os.getcwd()
if current_directory.endswith("notebooks"):
    os.chdir("..")
    print("Changed directory to:", os.getcwd())
else:
    print("Directory was already correct, so did not change.")
```

```{python}
from PIL import Image
from src.utils import (
    read_data, 
    get_tissue_crops_scaled_tensor,
    get_partition_from_file_name
)
```

```{python}
on_idun = os.getcwd().startswith("/cluster")

if on_idun:
  data_path = "/cluster/projects/vc/data/mic/open/OCELOT/ocelot_data"
else: 
  data_path = "ocelot_data/"
train_data, val_data, test_data = read_data(data_path)
total_data = {}
total_data.update(train_data)
total_data.update(val_data)
total_data.update(test_data)
```

```{python}
train_data = {k: train_data[k] for k in sorted(train_data, key=int)}
val_data = {k: val_data[k] for k in sorted(val_data, key=int)}
test_data = {k: test_data[k] for k in sorted(test_data, key=int)}
total_data = {k: total_data[k] for k in sorted(total_data, key=int)}
```

```{python}
train_cropped_tissue = get_tissue_crops_scaled_tensor(
    data=train_data
)
val_cropped_tissue = get_tissue_crops_scaled_tensor(
    data=val_data
)
test_cropped_tissue = get_tissue_crops_scaled_tensor(
    data=test_data
)

train_cropped_tissue = train_cropped_tissue[:, 3]
val_cropped_tissue = val_cropped_tissue[:, 3]
test_cropped_tissue = test_cropped_tissue[:, 3]
```

```{python}
train_cropped_tissue[train_cropped_tissue == 255.] = 1.
val_cropped_tissue[val_cropped_tissue == 255.] = 1.
test_cropped_tissue[test_cropped_tissue == 255.] = 1.

train_cropped_tissue -= 1
val_cropped_tissue -= 1
test_cropped_tissue -= 1
```

```{python}
train_folder = os.path.join(data_path, "annotations/train/cropped_tissue")
val_folder = os.path.join(data_path, "annotations/val/cropped_tissue")
test_folder = os.path.join(data_path, "annotations/test/cropped_tissue")
os.makedirs(train_folder, exist_ok=True)
os.makedirs(val_folder, exist_ok=True)
os.makedirs(test_folder, exist_ok=True)
```

```{python}
for (key, value) in total_data.items(): 
    temp_dict = {key: value}
    cropped_tensor = get_tissue_crops_scaled_tensor(data=temp_dict)
    cropped_tensor = cropped_tensor[:, 3]
    cropped_tensor[cropped_tensor == 255.] = 1.
    cropped_tensor -= 1

    partition = get_partition_from_file_name(key)
    image_folder = os.path.join(data_path, "annotations", partition, "cropped_tissue")

    img = Image.fromarray(cropped_tensor.squeeze().numpy().astype("uint8"))
    img.save(f"{image_folder}/{key}.png")
```
